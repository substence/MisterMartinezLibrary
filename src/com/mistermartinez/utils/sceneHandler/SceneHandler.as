package com.mistermartinez.utils.sceneHandler{			import com.greensock.TweenLite;	import com.mistermartinez.interfaces.ISpatial;	import com.mistermartinez.interfaces.IUpdatable;	import com.mistermartinez.math.Vector2D;		import flash.display.*;	import flash.events.Event;	import flash.events.MouseEvent;	import flash.filters.BitmapFilter;	import flash.geom.Point;	import flash.geom.Rectangle;	import flash.utils.Dictionary;		import mx.controls.Label;
		public class SceneHandler implements IUpdatable	{							private static var _instance:SceneHandler;		private var _camera:SceneCamera; 		private var _canvas:Bitmap;		private var _magnification:Number;		private var _layers:Dictionary;			private var _trackee:ISpatial;		private var _trackingEase:Number;		private var _trackingOffset:Function;		private var _view:BitmapData;		private var _container:Sprite;		public var doCameraBoundsScaleDynamically:Boolean;				public static function get instance():SceneHandler		{			if(!_instance)				throw new Error("You must first initialize");			return _instance;		}				public function get camera():SceneCamera		{			return _camera;		}				public function set magnification(value:Number):void		{			_magnification = value;		}				public function get magnification():Number		{			return _magnification;		}				public function SceneHandler(stage:Stage, bounds:Rectangle = null)		{			_magnification = 1;			_trackingEase = 0;			_layers = new Dictionary();			_container = new Sprite();			_camera = new SceneCamera();			doCameraBoundsScaleDynamically = !bounds;			if (bounds)				_camera.bounds = bounds;			stage.addEventListener(Event.RESIZE, updateCameraSize);			stage.dispatchEvent(new Event(Event.RESIZE));			updateBounds();		}				public static function initialize(stage:Stage, bounds:Rectangle = null):void		{			if(_instance)				return;			_instance = new SceneHandler(stage, bounds);		}				private function updateBounds(event:Event = null):void		{			if (!doCameraBoundsScaleDynamically)				return;			_camera.bounds.width = _canvas.stage.stageWidth;			_camera.bounds.height = _canvas.stage.stageHeight;		}				private function updateCameraSize(event:Event = null):void		{			var stage:Stage = Stage(event.target);			var width:Number = stage.stageWidth;			var height:Number = stage.stageHeight;			_camera.width = width;			_camera.height = height;			_view = new BitmapData(width, height);			if (_canvas)				stage.removeChild(_canvas);							_canvas = new Bitmap(_view);				stage.addChild(_canvas);		}				public function setMagnification(value:Number, transitionDuration:Number = 0):void		{			TweenLite.to(this, transitionDuration, {magnification: value});		}				public function addCameraLayer(label:String, layer:SceneLayer, index:int = 0):Sprite		{			index = index == 0 ? _container.numChildren : index;			_layers[label] = layer;			_container.addChildAt(layer.canvas, index);					return layer.canvas;		}				public function removeCameraLayer(label:String):void		{			_container.removeChild(_layers[label].canvas);							_layers[label] = null		}						public function getLayerByLabel(label:String):SceneLayer		{				return _layers[label];		}								public function panCameraTo(x:Number, y:Number, transitionDuration:Number = 0):void		{			TweenLite.to(_camera, transitionDuration, {x:x, y:y});					}				public function track(value:ISpatial, easing:Number = 0):void		{			_trackee = value;			_trackingEase = easing;			setCustomTrackingOffset(getCenterOffset);		}				public function setCustomTrackingOffset(getOffsetPoint:Function):void		{			_trackingOffset = getOffsetPoint;			}				public function update():void		{						if(_trackee)			{				var offset:Point = _trackingOffset();				var trackeePosition:Vector2D = _trackee.position;				panCameraTo(trackeePosition.x + offset.x, trackeePosition.y + offset.y, _trackingEase);			}			_canvas.scaleX = _magnification;			_canvas.scaleY = _magnification;							_view.lock();				_view.fillRect(_view.rect, 0x00FF00);			var containerBitmapData:BitmapData = new BitmapData(_camera.bounds.width, _camera.bounds.height);			containerBitmapData.draw(_container, null, null, null, _camera.rectangle);			_view.copyPixels(containerBitmapData, _camera.rectangle, new Point());			_view.unlock();						}					public function addChildByLabel(displayObject:DisplayObject, screenLabel:String):Boolean		{			var layer:SceneLayer = getLayerByLabel(screenLabel);			if (!layer)				return false;			layer.canvas.addChild(displayObject);			return true;		}				public function getScreenPosition(value:ISpatial):Vector2D		{			return value.position.subtract(_camera.position).multiply(magnification);		}				public function isObjectOnScreen(value:ISpatial):Boolean		{			var translatedPoint:Vector2D = getScreenPosition(value);			return (translatedPoint.x < 0 || translatedPoint.y < 0 || translatedPoint.x > _camera.width || translatedPoint.y > _camera.height);		}				private function getCenterOffset():Point		{			return new Point(-(_camera.width * .5) / _magnification, 							 -(_camera.height * .5) / _magnification)		}	}}